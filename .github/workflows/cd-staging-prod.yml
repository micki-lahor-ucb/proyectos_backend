name: CD - Staging + Production

on:
  push:
    branches:
      - 'main'
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Artifact
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build backend
        run: npm run build

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Create RELEASE_ID
        run: |
          RELEASE_ID=$(date +%Y%m%d_%H%M%S)_${GITHUB_SHA:0:7}
          echo "$RELEASE_ID" > RELEASE_ID
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "Created RELEASE_ID: $RELEASE_ID"

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-release-${{ github.ref_name }}
          path: |
            dist
            node_modules
            package.json
            package-lock.json
            prisma
            RELEASE_ID

  deploy_staging:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted  # Cambiar a ubuntu-latest si usas ngrok
    needs: [build]
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-release-${{ github.ref_name }}
          path: ./artifact

      - name: Read RELEASE_ID
        id: release
        shell: pwsh
        run: |
          $RELEASE_ID = Get-Content ./artifact/RELEASE_ID -Raw
          $RELEASE_ID = $RELEASE_ID.Trim()
          Add-Content -Path $env:GITHUB_OUTPUT -Value "RELEASE_ID=$RELEASE_ID"
          Write-Host "Deploying release: $RELEASE_ID"

      - name: Deploy backend to staging
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PORT: "2222"
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir -Force | Out-Null }
          
          # Save SSH key with proper format (no BOM, LF line endings)
          $keyContent = $env:STAGING_SSH_KEY
          $keyContent = $keyContent -replace "`r`n", "`n" -replace "`r", "`n"
          $keyContent = $keyContent.TrimEnd("`n", "`r") + "`n"
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          $bytes = $utf8NoBom.GetBytes($keyContent)
          [System.IO.File]::WriteAllBytes("$sshDir\deploy_key", $bytes)
          icacls "$sshDir\deploy_key" /inheritance:r /grant "$env:USERNAME`:F" | Out-Null
          
          $env:RELEASE = "${{ steps.release.outputs.RELEASE_ID }}"
          
          Write-Host "Creating release directory..."
          # Create release directory with timeout
          $sshArgs = @(
            "-i", "$sshDir\deploy_key",
            "-p", $env:STAGING_PORT,
            "-o", "StrictHostKeyChecking=no",
            "-o", "BatchMode=yes",
            "-o", "IdentitiesOnly=yes",
            "-o", "PreferredAuthentications=publickey",
            "-o", "ConnectTimeout=10",
            "-o", "ServerAliveInterval=5",
            "-o", "ServerAliveCountMax=3",
            "$env:STAGING_USER@$env:STAGING_HOST",
            "mkdir -p /var/www/project-management/releases/$env:RELEASE"
          )
          & ssh @sshArgs
          if ($LASTEXITCODE -ne 0) { throw "Failed to create release directory" }
          
          Write-Host "Copying files..."
          # Copy backend files using scp (more reliable than rsync on Windows)
          $scpArgs = @(
            "-i", "$sshDir\deploy_key",
            "-P", $env:STAGING_PORT,
            "-o", "StrictHostKeyChecking=no",
            "-o", "BatchMode=yes",
            "-o", "IdentitiesOnly=yes",
            "-o", "PreferredAuthentications=publickey",
            "-o", "ConnectTimeout=10",
            "-r",
            "./artifact/*"
          )
          $scpTarget = "$env:STAGING_USER@$env:STAGING_HOST:/var/www/project-management/releases/$env:RELEASE/"
          & scp @scpArgs $scpTarget
          if ($LASTEXITCODE -ne 0) { throw "Failed to copy files" }
          
          Write-Host "Running migrations and switching symlink..."
          # Link shared .env and run migrations
          $deployScript = "cd /var/www/project-management/releases/$env:RELEASE`n" +
            "ln -sfn /var/www/project-management/shared/.env /var/www/project-management/releases/$env:RELEASE/.env`n" +
            "export NODE_ENV=staging`n" +
            "export RELEASE_ID=$env:RELEASE`n" +
            "npx prisma migrate deploy`n" +
            "ln -sfn /var/www/project-management/releases/$env:RELEASE /var/www/project-management/current`n"
          $sshDeployArgs = @(
            "-i", "$sshDir\deploy_key",
            "-p", $env:STAGING_PORT,
            "-o", "StrictHostKeyChecking=no",
            "-o", "BatchMode=yes",
            "-o", "IdentitiesOnly=yes",
            "-o", "PreferredAuthentications=publickey",
            "-o", "ConnectTimeout=10",
            "-o", "ServerAliveInterval=5",
            "-o", "ServerAliveCountMax=3",
            "$env:STAGING_USER@$env:STAGING_HOST",
            "bash"
          )
          $deployScript | & ssh @sshDeployArgs
          if ($LASTEXITCODE -ne 0) { throw "Failed to deploy" }
          
          Write-Host "Deployment completed successfully"

      - name: Health check staging
        env:
          STAGING_APP_URL: ${{ secrets.STAGING_APP_URL }}
        shell: pwsh
        run: |
          Start-Sleep -Seconds 5
          $response = Invoke-WebRequest -Uri "$env:STAGING_APP_URL/api/health" -UseBasicParsing
          if ($response.StatusCode -ne 200) { exit 1 }

  rollback_staging:
    name: Rollback Staging
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: self-hosted  # Cambiar a ubuntu-latest si usas ngrok
    needs: [deploy_staging]
    environment:
      name: staging
    steps:
      - name: Rollback to previous release
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PORT: "2222"
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir -Force | Out-Null }
          
          # Save SSH key with proper format (no BOM, LF line endings)
          $keyContent = $env:STAGING_SSH_KEY
          $keyContent = $keyContent -replace "`r`n", "`n" -replace "`r", "`n"
          $keyContent = $keyContent.TrimEnd("`n", "`r") + "`n"
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          $bytes = $utf8NoBom.GetBytes($keyContent)
          [System.IO.File]::WriteAllBytes("$sshDir\deploy_key", $bytes)
          icacls "$sshDir\deploy_key" /inheritance:r /grant "$env:USERNAME`:F" | Out-Null
          
          $rollbackScript = "PREV=`$(ls -1dt /var/www/project-management/releases/*/ 2>/dev/null | sed -n '2p' | tr -d '/')`n" +
            "if [ -n \"`$PREV\" ]; then`n" +
            "  echo \"Rolling back to: `$PREV\"`n" +
            "  ln -sfn `$PREV /var/www/project-management/current`n" +
            "else`n" +
            "  echo \"No previous release found for rollback\"`n" +
            "  exit 1`n" +
            "fi`n"
          $rollbackScript | & ssh -i "$sshDir\deploy_key" -p $env:STAGING_PORT -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 "$env:STAGING_USER@$env:STAGING_HOST" bash

  deploy_production:
    name: Deploy to Production
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted  # Cambiar a ubuntu-latest si usas ngrok
    needs: [build]
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-release-${{ github.ref_name }}
          path: ./artifact

      - name: Read RELEASE_ID
        id: release
        shell: pwsh
        run: |
          $RELEASE_ID = Get-Content ./artifact/RELEASE_ID -Raw
          $RELEASE_ID = $RELEASE_ID.Trim()
          Add-Content -Path $env:GITHUB_OUTPUT -Value "RELEASE_ID=$RELEASE_ID"
          Write-Host "Deploying release: $RELEASE_ID"

      - name: Deploy backend to production
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: "2223"
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir -Force | Out-Null }
          
          # Save SSH key with proper format (no BOM, LF line endings)
          $keyContent = $env:PROD_SSH_KEY
          $keyContent = $keyContent -replace "`r`n", "`n" -replace "`r", "`n"
          $keyContent = $keyContent.TrimEnd("`n", "`r") + "`n"
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          $bytes = $utf8NoBom.GetBytes($keyContent)
          [System.IO.File]::WriteAllBytes("$sshDir\deploy_key", $bytes)
          icacls "$sshDir\deploy_key" /inheritance:r /grant "$env:USERNAME`:F" | Out-Null
          
          $env:RELEASE = "${{ steps.release.outputs.RELEASE_ID }}"
          
          Write-Host "Creating release directory..."
          # Create release directory with timeout
          $sshArgs = @(
            "-i", "$sshDir\deploy_key",
            "-p", $env:PROD_PORT,
            "-o", "StrictHostKeyChecking=no",
            "-o", "BatchMode=yes",
            "-o", "IdentitiesOnly=yes",
            "-o", "PreferredAuthentications=publickey",
            "-o", "ConnectTimeout=10",
            "-o", "ServerAliveInterval=5",
            "-o", "ServerAliveCountMax=3",
            "$env:PROD_USER@$env:PROD_HOST",
            "mkdir -p /var/www/project-management/releases/$env:RELEASE"
          )
          & ssh @sshArgs
          if ($LASTEXITCODE -ne 0) { throw "Failed to create release directory" }
          
          Write-Host "Copying files..."
          # Copy backend files using scp (more reliable than rsync on Windows)
          $scpArgs = @(
            "-i", "$sshDir\deploy_key",
            "-P", $env:PROD_PORT,
            "-o", "StrictHostKeyChecking=no",
            "-o", "BatchMode=yes",
            "-o", "IdentitiesOnly=yes",
            "-o", "PreferredAuthentications=publickey",
            "-o", "ConnectTimeout=10",
            "-r",
            "./artifact/*"
          )
          $scpTarget = "$env:PROD_USER@$env:PROD_HOST:/var/www/project-management/releases/$env:RELEASE/"
          & scp @scpArgs $scpTarget
          if ($LASTEXITCODE -ne 0) { throw "Failed to copy files" }
          
          Write-Host "Running migrations and switching symlink..."
          # Link shared .env and run migrations
          $deployScript = "cd /var/www/project-management/releases/$env:RELEASE`n" +
            "ln -sfn /var/www/project-management/shared/.env /var/www/project-management/releases/$env:RELEASE/.env`n" +
            "export NODE_ENV=production`n" +
            "export RELEASE_ID=$env:RELEASE`n" +
            "npx prisma migrate deploy`n" +
            "ln -sfn /var/www/project-management/releases/$env:RELEASE /var/www/project-management/current`n"
          $sshDeployArgs = @(
            "-i", "$sshDir\deploy_key",
            "-p", $env:PROD_PORT,
            "-o", "StrictHostKeyChecking=no",
            "-o", "BatchMode=yes",
            "-o", "IdentitiesOnly=yes",
            "-o", "PreferredAuthentications=publickey",
            "-o", "ConnectTimeout=10",
            "-o", "ServerAliveInterval=5",
            "-o", "ServerAliveCountMax=3",
            "$env:PROD_USER@$env:PROD_HOST",
            "bash"
          )
          $deployScript | & ssh @sshDeployArgs
          if ($LASTEXITCODE -ne 0) { throw "Failed to deploy" }
          
          Write-Host "Deployment completed successfully"

      - name: Health check production
        env:
          PROD_APP_URL: ${{ secrets.PROD_APP_URL }}
        shell: pwsh
        run: |
          Start-Sleep -Seconds 5
          $response = Invoke-WebRequest -Uri "$env:PROD_APP_URL/api/health" -UseBasicParsing
          if ($response.StatusCode -ne 200) { exit 1 }

  rollback_production:
    name: Rollback Production
    if: failure() && (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch')
    runs-on: self-hosted  # Cambiar a ubuntu-latest si usas ngrok
    needs: [deploy_production]
    environment:
      name: production
    steps:
      - name: Rollback to previous release
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: "2223"
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir -Force | Out-Null }
          
          # Save SSH key with proper format (no BOM, LF line endings)
          $keyContent = $env:PROD_SSH_KEY
          $keyContent = $keyContent -replace "`r`n", "`n" -replace "`r", "`n"
          $keyContent = $keyContent.TrimEnd("`n", "`r") + "`n"
          $utf8NoBom = New-Object System.Text.UTF8Encoding $false
          $bytes = $utf8NoBom.GetBytes($keyContent)
          [System.IO.File]::WriteAllBytes("$sshDir\deploy_key", $bytes)
          icacls "$sshDir\deploy_key" /inheritance:r /grant "$env:USERNAME`:F" | Out-Null
          
          $rollbackScript = "PREV=`$(ls -1dt /var/www/project-management/releases/*/ 2>/dev/null | sed -n '2p' | tr -d '/')`n" +
            "if [ -n \"`$PREV\" ]; then`n" +
            "  echo \"Rolling back to: `$PREV\"`n" +
            "  ln -sfn `$PREV /var/www/project-management/current`n" +
            "else`n" +
            "  echo \"No previous release found for rollback\"`n" +
            "  exit 1`n" +
            "fi`n"
          $rollbackScript | & ssh -i "$sshDir\deploy_key" -p $env:PROD_PORT -o StrictHostKeyChecking=no -o BatchMode=yes -o IdentitiesOnly=yes -o PreferredAuthentications=publickey -o ConnectTimeout=10 -o ServerAliveInterval=5 -o ServerAliveCountMax=3 "$env:PROD_USER@$env:PROD_HOST" bash
