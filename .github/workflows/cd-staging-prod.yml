name: CD - Staging + Production

on:
  push:
    branches:
      - 'main'
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    name: Build Artifact
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build backend
        run: npm run build

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Create RELEASE_ID
        run: |
          RELEASE_ID=$(date +%Y%m%d_%H%M%S)_${GITHUB_SHA:0:7}
          echo "$RELEASE_ID" > RELEASE_ID
          echo "RELEASE_ID=$RELEASE_ID" >> $GITHUB_ENV
          echo "Created RELEASE_ID: $RELEASE_ID"

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-release-${{ github.ref_name }}
          path: |
            dist
            node_modules
            package.json
            package-lock.json
            prisma
            RELEASE_ID

  deploy_staging:
    name: Deploy to Staging
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted  # Cambiar a ubuntu-latest si usas ngrok
    needs: [build]
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-release-${{ github.ref_name }}
          path: ./artifact

      - name: Read RELEASE_ID
        id: release
        shell: pwsh
        run: |
          $RELEASE_ID = Get-Content ./artifact/RELEASE_ID -Raw
          $RELEASE_ID = $RELEASE_ID.Trim()
          Add-Content -Path $env:GITHUB_OUTPUT -Value "RELEASE_ID=$RELEASE_ID"
          Write-Host "Deploying release: $RELEASE_ID"

      - name: Deploy backend to staging
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PORT: "2222"
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir -Force | Out-Null }
          
          $STAGING_SSH_KEY | Out-File -FilePath "$sshDir\deploy_key" -Encoding utf8 -NoNewline
          icacls "$sshDir\deploy_key" /inheritance:r /grant "$env:USERNAME`:F" | Out-Null
          
          $env:RELEASE = "${{ steps.release.outputs.RELEASE_ID }}"
          
          # Create release directory
          & ssh -i "$sshDir\deploy_key" -p $env:STAGING_PORT -o StrictHostKeyChecking=no "$env:STAGING_USER@$env:STAGING_HOST" "mkdir -p /var/www/project-management/releases/$env:RELEASE"
          
          # Copy backend files using rsync (requires Git Bash or WSL)
          $bashPath = "C:\Program Files\Git\bin\bash.exe"
          if (Test-Path $bashPath) {
            & $bashPath -c "rsync -avz -e `"ssh -i $sshDir/deploy_key -p $env:STAGING_PORT`" ./artifact/ $env:STAGING_USER@$env:STAGING_HOST:/var/www/project-management/releases/$env:RELEASE/"
          } else {
            # Fallback: use scp
            & scp -i "$sshDir\deploy_key" -P $env:STAGING_PORT -r ./artifact/* "$env:STAGING_USER@$env:STAGING_HOST:/var/www/project-management/releases/$env:RELEASE/"
          }
          
          # Link shared .env and run migrations
          $deployScript = @"
          cd /var/www/project-management/releases/$env:RELEASE
          ln -sfn /var/www/project-management/shared/.env /var/www/project-management/releases/$env:RELEASE/.env
          export NODE_ENV=staging
          export RELEASE_ID=$env:RELEASE
          npx prisma migrate deploy
          ln -sfn /var/www/project-management/releases/$env:RELEASE /var/www/project-management/current
          "@
          $deployScript | & ssh -i "$sshDir\deploy_key" -p $env:STAGING_PORT -o StrictHostKeyChecking=no "$env:STAGING_USER@$env:STAGING_HOST" bash

      - name: Health check staging
        env:
          STAGING_APP_URL: ${{ secrets.STAGING_APP_URL }}
        shell: pwsh
        run: |
          Start-Sleep -Seconds 5
          $response = Invoke-WebRequest -Uri "$env:STAGING_APP_URL/api/health" -UseBasicParsing
          if ($response.StatusCode -ne 200) { exit 1 }

  rollback_staging:
    name: Rollback Staging
    if: failure() && github.ref == 'refs/heads/main'
    runs-on: self-hosted  # Cambiar a ubuntu-latest si usas ngrok
    needs: [deploy_staging]
    environment:
      name: staging
    steps:
      - name: Rollback to previous release
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
          STAGING_PORT: "2222"
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir -Force | Out-Null }
          
          $STAGING_SSH_KEY | Out-File -FilePath "$sshDir\deploy_key" -Encoding utf8 -NoNewline
          icacls "$sshDir\deploy_key" /inheritance:r /grant "$env:USERNAME`:F" | Out-Null
          
          $rollbackScript = @"
          PREV=`$(ls -1dt /var/www/project-management/releases/*/ 2>/dev/null | sed -n '2p' | tr -d '/')
          if [ -n "`$PREV" ]; then
            echo "Rolling back to: `$PREV"
            ln -sfn `$PREV /var/www/project-management/current
          else
            echo "No previous release found for rollback"
            exit 1
          fi
          "@
          $rollbackScript | & ssh -i "$sshDir\deploy_key" -p $env:STAGING_PORT -o StrictHostKeyChecking=no "$env:STAGING_USER@$env:STAGING_HOST" bash

  deploy_production:
    name: Deploy to Production
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    runs-on: self-hosted  # Cambiar a ubuntu-latest si usas ngrok
    needs: [build]
    environment:
      name: production
    steps:
      - uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-release-${{ github.ref_name }}
          path: ./artifact

      - name: Read RELEASE_ID
        id: release
        shell: pwsh
        run: |
          $RELEASE_ID = Get-Content ./artifact/RELEASE_ID -Raw
          $RELEASE_ID = $RELEASE_ID.Trim()
          Add-Content -Path $env:GITHUB_OUTPUT -Value "RELEASE_ID=$RELEASE_ID"
          Write-Host "Deploying release: $RELEASE_ID"

      - name: Deploy backend to production
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: "2223"
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir -Force | Out-Null }
          
          $PROD_SSH_KEY | Out-File -FilePath "$sshDir\deploy_key" -Encoding utf8 -NoNewline
          icacls "$sshDir\deploy_key" /inheritance:r /grant "$env:USERNAME`:F" | Out-Null
          
          $env:RELEASE = "${{ steps.release.outputs.RELEASE_ID }}"
          
          # Create release directory
          & ssh -i "$sshDir\deploy_key" -p $env:PROD_PORT -o StrictHostKeyChecking=no "$env:PROD_USER@$env:PROD_HOST" "mkdir -p /var/www/project-management/releases/$env:RELEASE"
          
          # Copy backend files using rsync (requires Git Bash or WSL)
          $bashPath = "C:\Program Files\Git\bin\bash.exe"
          if (Test-Path $bashPath) {
            & $bashPath -c "rsync -avz -e `"ssh -i $sshDir/deploy_key -p $env:PROD_PORT`" ./artifact/ $env:PROD_USER@$env:PROD_HOST:/var/www/project-management/releases/$env:RELEASE/"
          } else {
            # Fallback: use scp
            & scp -i "$sshDir\deploy_key" -P $env:PROD_PORT -r ./artifact/* "$env:PROD_USER@$env:PROD_HOST:/var/www/project-management/releases/$env:RELEASE/"
          }
          
          # Link shared .env and run migrations
          $deployScript = @"
          cd /var/www/project-management/releases/$env:RELEASE
          ln -sfn /var/www/project-management/shared/.env /var/www/project-management/releases/$env:RELEASE/.env
          export NODE_ENV=production
          export RELEASE_ID=$env:RELEASE
          npx prisma migrate deploy
          ln -sfn /var/www/project-management/releases/$env:RELEASE /var/www/project-management/current
          "@
          $deployScript | & ssh -i "$sshDir\deploy_key" -p $env:PROD_PORT -o StrictHostKeyChecking=no "$env:PROD_USER@$env:PROD_HOST" bash

      - name: Health check production
        env:
          PROD_APP_URL: ${{ secrets.PROD_APP_URL }}
        shell: pwsh
        run: |
          Start-Sleep -Seconds 5
          $response = Invoke-WebRequest -Uri "$env:PROD_APP_URL/api/health" -UseBasicParsing
          if ($response.StatusCode -ne 200) { exit 1 }

  rollback_production:
    name: Rollback Production
    if: failure() && (startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch')
    runs-on: self-hosted  # Cambiar a ubuntu-latest si usas ngrok
    needs: [deploy_production]
    environment:
      name: production
    steps:
      - name: Rollback to previous release
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
          PROD_PORT: "2223"
        shell: pwsh
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) { New-Item -ItemType Directory -Path $sshDir -Force | Out-Null }
          
          $PROD_SSH_KEY | Out-File -FilePath "$sshDir\deploy_key" -Encoding utf8 -NoNewline
          icacls "$sshDir\deploy_key" /inheritance:r /grant "$env:USERNAME`:F" | Out-Null
          
          $rollbackScript = @"
          PREV=`$(ls -1dt /var/www/project-management/releases/*/ 2>/dev/null | sed -n '2p' | tr -d '/')
          if [ -n "`$PREV" ]; then
            echo "Rolling back to: `$PREV"
            ln -sfn `$PREV /var/www/project-management/current
          else
            echo "No previous release found for rollback"
            exit 1
          fi
          "@
          $rollbackScript | & ssh -i "$sshDir\deploy_key" -p $env:PROD_PORT -o StrictHostKeyChecking=no "$env:PROD_USER@$env:PROD_HOST" bash
